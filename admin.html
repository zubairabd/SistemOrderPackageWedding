<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - WeddingOrg Pro</title>
    
    <!-- Impor Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #a8a29e; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #78716c; }

        /* Style Kalender */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: 1px; background-color: #e7e5e4; border: 1px solid #e7e5e4; }
        .calendar-header { text-align: center; font-weight: 600; padding: 0.5rem 0.25rem; background-color: #f5f5f4; font-size: 0.875rem; }
        .calendar-day { min-height: 80px; padding: 0.5rem; background-color: white; position: relative; font-size: 0.875rem; transition: background-color 0.2s; }
        .calendar-day.other-month { background-color: #fafaf9; color: #a8a29e; }
        .calendar-day span { display: block; text-align: right; margin-bottom: 0.25rem; pointer-events: none; /* Agar klik pada span tidak mengganggu */ }
        .calendar-day.has-booking { background-color: #fef3c7; cursor: pointer; }
        .calendar-day.has-booking:hover { background-color: #fde68a; }
        .calendar-day.selected { background-color: #fcd34d !important; border: 1px solid #fbbf24; } /* amber-300 & amber-400 */
        .booking-dot { position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; background-color: #c2410c; border-radius: 50%; pointer-events: none; /* Agar klik pada dot tidak mengganggu */ } /* red-700 */
        
        /* Style detail acara & checklist */
        .event-detail { background-color: #fffbeb; border-left: 4px solid #f59e0b; padding: 0.75rem 1rem; margin-top: 0.5rem; border-radius: 0.375rem; } /* amber-50 & amber-500 */
        .checklist-item { display: flex; align-items: center; margin-bottom: 0.5rem; padding: 0.25rem 0; transition: background-color 0.1s; }
        .checklist-item:hover { background-color: #f3f4f6; } /* gray-100 */
        .checklist-item input[type="checkbox"] { margin-right: 0.75rem; width: 1rem; height: 1rem; color: #d97706; focus:ring-amber-500 border-gray-300 rounded cursor-pointer; } /* amber-600 */
        .checklist-item label { flex-grow: 1; color: #374151; cursor: pointer; } /* gray-700 */
        .checklist-item label.done { text-decoration: line-through; color: #6b7280; } /* gray-500 */
        .checklist-item input:disabled + label { color: #9ca3af; cursor: not-allowed; } /* gray-400 */
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-20">
            <a href="index.html" class="text-3xl font-bold text-amber-800">WeddingOrg Pro (Admin)</a>
            <div class="flex items-center space-x-4">
                <span id="welcome-message-admin" class="text-gray-700 hidden md:block">Selamat datang, Admin!</span>
                <button id="logout-btn-admin" class="bg-red-600 text-white py-2 px-5 rounded-lg shadow font-semibold hover:bg-red-700 transition duration-200">
                    Logout
                </button>
            </div>
        </nav>
    </header>

    <!-- Konten Utama -->
    <main class="flex-grow bg-stone-50 py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            
            <div id="loading-message-admin" class="text-center py-20">
                <p class="text-xl text-gray-600">Memuat data admin...</p>
            </div>

            <div id="admin-content" class="hidden space-y-12">

                <!-- Ringkasan Keuangan -->
                <section id="financial-summary-section">
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">Ringkasan Keuangan</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                            <h3 class="text-lg font-semibold text-gray-500 mb-2">Total Pendapatan (Lunas)</h3>
                            <p id="total-revenue" class="text-4xl font-bold text-green-700">Rp 0</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500">
                            <h3 class="text-lg font-semibold text-gray-500 mb-2">Jumlah Pesanan Lunas</h3>
                            <p id="total-paid-orders" class="text-4xl font-bold text-blue-700">0</p>
                        </div>
                    </div>
                </section>

                <!-- Kalender Jadwal & Progress -->
                <section id="calendar-schedule-section">
                     <h2 class="text-3xl font-bold text-gray-900 mb-6">Kalender Jadwal & Progress</h2>
                     <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                         <!-- Kolom Kalender -->
                         <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6">
                            <div class="flex justify-between items-center mb-4">
                                <button id="prev-month-btn" class="p-2 rounded-md hover:bg-gray-100 text-gray-600"> <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg> </button>
                                <h3 id="current-month-year" class="text-xl font-semibold text-gray-800"></h3>
                                <button id="next-month-btn" class="p-2 rounded-md hover:bg-gray-100 text-gray-600"> <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg> </button>
                            </div>
                            <div class="calendar-grid mb-1">
                                <div class="calendar-header">Min</div> <div class="calendar-header">Sen</div> <div class="calendar-header">Sel</div> <div class="calendar-header">Rab</div> <div class="calendar-header">Kam</div> <div class="calendar-header">Jum</div> <div class="calendar-header">Sab</div>
                            </div>
                            <div id="calendar-grid-body" class="calendar-grid">
                                <!-- Kalender di-generate JS -->
                            </div>
                         </div>
                         <!-- Kolom Detail Acara & Checklist -->
                         <div class="lg:col-span-1">
                             <div class="bg-white rounded-xl shadow-lg p-6 sticky top-24">
                                 <h3 class="text-xl font-semibold text-gray-800 mb-4">Detail Acara & Progress</h3>
                                 <div id="event-details-container">
                                     <p class="text-gray-500">Klik tanggal pada kalender untuk melihat detail.</p>
                                 </div>
                                 <div id="checklist-container" class="mt-6 border-t pt-4 hidden">
                                     <h4 class="font-semibold text-lg mb-3 text-gray-700">Checklist Persiapan</h4>
                                     <div id="checklist-items" class="space-y-1 max-h-60 overflow-y-auto pr-2">
                                         <p class="text-gray-500 text-sm">Memuat checklist...</p>
                                     </div>
                                     <p id="checklist-message" class="text-xs text-gray-400 mt-2"></p> 
                                 </div>
                             </div>
                         </div>
                     </div>
                 </section>

                <!-- Manajemen Pesanan -->
                <section id="order-management-section">
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">Manajemen Pesanan Klien</h2>
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Klien</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paket</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Acara</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Harga</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status Bayar</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bukti Bayar</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="order-list-admin" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Memuat pesanan...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
            </div> 
            
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-12 py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-gray-500 text-sm">&copy; 2025 WeddingOrg Pro. Admin Area.</p>
        </div>
    </footer>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Admin dashboard script loaded."); 

            const API_URL = 'http://localhost:3000/api';
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user'));

            if (!token || !user || user.role !== 'admin') {
                console.error("Akses ditolak."); alert('Akses ditolak.'); localStorage.removeItem('token'); localStorage.removeItem('user'); window.location.href = 'index.html'; return;
            }

            const loadingMessage = document.getElementById('loading-message-admin');
            const adminContent = document.getElementById('admin-content');
            const welcomeMessage = document.getElementById('welcome-message-admin');
            const orderListAdmin = document.getElementById('order-list-admin');
            const calendarGridBody = document.getElementById('calendar-grid-body');
            const currentMonthYearEl = document.getElementById('current-month-year');
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            const eventDetailsContainer = document.getElementById('event-details-container');
            const checklistContainer = document.getElementById('checklist-container');
            const checklistItemsEl = document.getElementById('checklist-items');
            const checklistMessage = document.getElementById('checklist-message');
            const totalRevenueEl = document.getElementById('total-revenue');
            const totalPaidOrdersEl = document.getElementById('total-paid-orders');

             console.log("calendarGridBody element:", calendarGridBody ? 'Found' : 'NOT FOUND!'); // DEBUG

            let currentDate = new Date();
            let allOrdersData = []; 

            // --- Fungsi Pembantu ---
            const formatRupiah = (angka) => {/*...*/ const num = Number(angka); if (isNaN(num)) return 'Rp 0'; return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num); };
            const formatDate = (dateString) => {/*...*/ if (!dateString) return '-'; const date = new Date(dateString); return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`; };
            const formatDateLong = (dateString) => {/*...*/ if (!dateString) return '-'; return new Date(dateString).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' }); };
            const getStatusBadge = (status) => {/*...*/ let c='inline-flex px-2.5 py-0.5 rounded-full text-xs font-medium '; switch(status){ case 'Belum Bayar':c+='bg-yellow-100 text-yellow-800';break; case 'Menunggu Konfirmasi':c+='bg-blue-100 text-blue-800';break; case 'Lunas':c+='bg-green-100 text-green-800';break; case 'Ditolak':c+='bg-red-100 text-red-800';break; default:c+='bg-gray-100 text-gray-800';} return `<span class="${c}">${status}</span>`; };
            const getOrderStatusBadge = (status) => {/*...*/ let c='inline-flex px-2.5 py-0.5 rounded-full text-xs font-medium '; switch(status){ case 'Pending':c+='bg-yellow-100 text-yellow-800';break; case 'Dikonfirmasi':c+='bg-blue-100 text-blue-800';break; case 'Persiapan':c+='bg-indigo-100 text-indigo-800';break; case 'Selesai':c+='bg-green-100 text-green-800';break; case 'Batal':c+='bg-red-100 text-red-800';break; default:c+='bg-gray-100 text-gray-800';} return `<span class="${c}">${status}</span>`; };

            // --- Fungsi Generate Kalender ---
            const generateCalendar = (year, month) => {
                console.log(`[generateCalendar] Generating for ${year}-${month + 1}`); 
                calendarGridBody.innerHTML = ''; 
                currentMonthYearEl.textContent = new Date(year, month).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
                const firstDayOfMonth = new Date(year, month, 1).getDay(); 
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let i = 0; i < firstDayOfMonth; i++) { calendarGridBody.innerHTML += `<div class="calendar-day other-month"></div>`; }
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateCell = document.createElement('div');
                    dateCell.className = 'calendar-day';
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    dateCell.dataset.date = dateStr; 
                    dateCell.innerHTML = `<span>${day}</span>`; 
                    const ordersOnThisDate = allOrdersData.filter(order => formatDate(order.tanggal_pernikahan) === dateStr && order.status_pesanan !== 'Batal' && order.status_pesanan !== 'Selesai');
                    
                    if (ordersOnThisDate.length > 0) {
                        dateCell.classList.add('has-booking');
                        dateCell.innerHTML += `<div class="booking-dot"></div>`;
                        // Tidak ada addEventListener di sini
                    }
                    calendarGridBody.appendChild(dateCell);
                }
                const totalCells = firstDayOfMonth + daysInMonth; const remainingCells = (7 - (totalCells % 7)) % 7; 
                for (let i = 0; i < remainingCells; i++) { calendarGridBody.innerHTML += `<div class="calendar-day other-month"></div>`; }
                console.log("[generateCalendar] Complete."); 
            };
            
            // --- Event Listener di Parent (Event Delegation) ---
            if (calendarGridBody) {
                 console.log("[Event Delegation] Adding listener to calendarGridBody."); // DEBUG
                calendarGridBody.addEventListener('click', (event) => {
                    console.log("[Event Delegation] Click detected inside grid body."); // DEBUG
                    const clickedDay = event.target.closest('.calendar-day.has-booking'); // Cari parent .calendar-day.has-booking
                    
                    if (clickedDay) {
                        const dateStr = clickedDay.dataset.date;
                        console.log(`[Event Delegation] Clicked on booked date cell: ${dateStr}`); // DEBUG
                        
                        // DEBUG: Tampilkan semua data order sebelum filter
                        console.log("[Event Delegation] All orders data before filter:", allOrdersData.map(o => ({ date: formatDate(o.tanggal_pernikahan), status: o.status_pesanan })) ); 

                        const ordersOnThisDate = allOrdersData.filter(order => 
                            formatDate(order.tanggal_pernikahan) === dateStr &&
                            order.status_pesanan !== 'Batal' && 
                            order.status_pesanan !== 'Selesai'
                        );
                        
                        // DEBUG: Tampilkan hasil filter
                        console.log(`[Event Delegation] Found ${ordersOnThisDate.length} active order(s) for ${dateStr}:`, ordersOnThisDate); 

                        if (ordersOnThisDate.length > 0) {
                             showBookingDetails(dateStr, ordersOnThisDate); // Panggil fungsi detail
                            // Highlight
                            document.querySelectorAll('.calendar-day.selected').forEach(el => el.classList.remove('selected', 'bg-amber-300', 'border', 'border-amber-400')); 
                            clickedDay.classList.add('selected', 'bg-amber-300', 'border', 'border-amber-400'); 
                        } else {
                            console.warn(`[Event Delegation] Clicked ${dateStr} but filter found no active orders?`); // DEBUG
                            eventDetailsContainer.innerHTML = `<h4 class="font-semibold text-lg mb-2">${formatDateLong(dateStr)}</h4><p class="text-gray-500">Tidak ada detail acara aktif ditemukan untuk tanggal ini.</p>`;
                            checklistContainer.classList.add('hidden');
                        }
                    } else {
                        console.log("[Event Delegation] Clicked on empty or non-booking cell."); // DEBUG
                    }
                });
            } else {
                 console.error("FATAL ERROR: calendarGridBody element not found! Click listener cannot be added."); // DEBUG
            }


            // --- Fungsi Menampilkan Detail Booking & Memuat Checklist ---
            const showBookingDetails = async (dateStr, orders) => {
                console.log(`[showBookingDetails] Showing details for ${dateStr}`); 
                if (!eventDetailsContainer) { console.error("ERROR: eventDetailsContainer not found!"); return; }
                eventDetailsContainer.innerHTML = `<h4 class="font-semibold text-lg mb-2">${formatDateLong(dateStr)}</h4>`;
                checklistContainer.classList.add('hidden'); 
                checklistItemsEl.innerHTML = '<p class="text-gray-500 text-sm">Memuat checklist...</p>'; 
                checklistMessage.textContent = ''; 
                if (!orders || orders.length === 0) { eventDetailsContainer.innerHTML += '<p class="text-gray-500">Tidak ada acara.</p>'; return; }
                const order = orders[0]; 
                eventDetailsContainer.innerHTML += `<div class="event-detail mb-4"><p><strong>Klien:</strong> ${order.nama_klien}</p><p><strong>Paket:</strong> ${order.nama_paket}</p><p><strong>Status Pesanan:</strong> ${getOrderStatusBadge(order.status_pesanan)}</p></div>`;
                if (order.status_pesanan === 'Dikonfirmasi' || order.status_pesanan === 'Persiapan') {
                     console.log("[showBookingDetails] Loading checklist..."); 
                     checklistContainer.classList.remove('hidden'); 
                     try {
                        checklistMessage.textContent = 'Memuat...';
                        const tasksResponse = await fetch(`${API_URL}/admin/orders/${order.order_id}/tasks`, { headers: { 'x-auth-token': token } });
                        if (!tasksResponse.ok) { const errTxt = await tasksResponse.text(); console.error("[showBookingDetails] Checklist fetch failed:", tasksResponse.status, errTxt); throw new Error(`Gagal load checklist (${tasksResponse.status}).`); }
                        const tasks = await tasksResponse.json();
                        renderChecklist(tasks); 
                        checklistMessage.textContent = tasks.length > 0 ? 'Checklist dimuat.' : 'Belum ada checklist.';
                     } catch (error) { console.error("[showBookingDetails] Error fetching checklist:", error); checklistItemsEl.innerHTML = `<p class="text-red-500 text-sm">Error: ${error.message}</p>`; checklistMessage.textContent = 'Gagal load.'; }
                } else { checklistContainer.classList.add('hidden'); eventDetailsContainer.innerHTML += '<p class="text-xs text-gray-500 mt-2">Checklist muncul setelah pembayaran dikonfirmasi.</p>'; }
                console.log("[showBookingDetails] Finished."); 
            };

            // --- Fungsi Render Checklist ---
            const renderChecklist = (tasks) => {
                 console.log("[renderChecklist] Rendering:", tasks); 
                 checklistItemsEl.innerHTML = ''; 
                 if (!tasks || tasks.length === 0) { checklistItemsEl.innerHTML = '<p class="text-gray-500 text-sm">Belum ada item checklist.</p>'; return; }
                 tasks.forEach(task => { const itemDiv = document.createElement('div'); itemDiv.className = 'checklist-item'; itemDiv.innerHTML = `<input type="checkbox" id="task-${task.task_id}" data-task-id="${task.task_id}" ${task.is_done ? 'checked' : ''} class="task-checkbox"> <label for="task-${task.task_id}" class="${task.is_done ? 'done' : ''}">${task.task_name}</label>`; checklistItemsEl.appendChild(itemDiv); });
                 const lastUpdatedTask = tasks.reduce((latest, task) => { const taskDate = new Date(task.updated_at || 0); return taskDate > new Date(latest.updated_at || 0) ? task : latest; }, { updated_at: null }); 
                 if (lastUpdatedTask && lastUpdatedTask.updated_at) { checklistMessage.textContent = `Update: ${new Date(lastUpdatedTask.updated_at).toLocaleString('id-ID', { timeStyle: 'short', dateStyle: 'short' })}`; } 
                 else if (tasks.length > 0) { checklistMessage.textContent = 'Belum diupdate.'; }
                 console.log("[renderChecklist] Complete."); 
            };

            // --- Handler untuk Toggle Checklist (Delegasi Event) ---
             checklistItemsEl.addEventListener('change', async (event) => {
                 if (event.target.classList.contains('task-checkbox')) {
                    const checkbox = event.target; const taskId = checkbox.dataset.taskId; const isDone = checkbox.checked; const label = checkbox.nextElementSibling; 
                    console.log(`[Checklist Toggle] Task ${taskId} -> ${isDone}`); 
                    checkbox.disabled = true; const originalMessage = checklistMessage.textContent; checklistMessage.textContent = 'Menyimpan...';
                    try {
                        const response = await fetch(`${API_URL}/admin/tasks/${taskId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'x-auth-token': token }, body: JSON.stringify({ is_done: isDone }) });
                        if (!response.ok) { const err = await response.json(); console.error("[Checklist Toggle] Error:", err); throw new Error(err.message || 'Gagal.'); }
                        const updatedTask = await response.json(); console.log("[Checklist Toggle] Success:", updatedTask); 
                        label.classList.toggle('done', isDone);
                        checklistMessage.textContent = `Disimpan (${new Date(updatedTask.updated_at).toLocaleTimeString('id-ID')})`; 
                    } catch (error) { console.error("[Checklist Toggle] Error caught:", error.message); checklistMessage.textContent = `Error! ${error.message}`; checkbox.checked = !isDone; setTimeout(() => { checklistMessage.textContent = originalMessage; }, 3000);
                    } finally { checkbox.disabled = false; }
                 }
             });


            // --- Fungsi Utama: Memuat Data Admin ---
            const loadAdminData = async () => {
                console.log("[loadAdminData] Loading..."); 
                try {
                    welcomeMessage.textContent = `Selamat datang, Admin ${user.nama}!`;
                    welcomeMessage.classList.remove('hidden');

                    const ordersResponse = await fetch(`${API_URL}/admin/orders`, { headers: { 'x-auth-token': token } });
                    if (!ordersResponse.ok) { const errTxt = await ordersResponse.text(); console.error("[loadAdminData] Failed fetch orders:", ordersResponse.status, errTxt); throw new Error(`Gagal load orders (${ordersResponse.status}).`); }
                    allOrdersData = await ordersResponse.json(); 
                    console.log("[loadAdminData] Orders data (raw):", allOrdersData); // DEBUG Raw Data
                    
                    // DEBUG: Cek format tanggal dari API
                    if (allOrdersData.length > 0) {
                        console.log("[loadAdminData] Example order date from API:", allOrdersData[0].tanggal_pernikahan);
                        console.log("[loadAdminData] Example formatted date:", formatDate(allOrdersData[0].tanggal_pernikahan));
                    }

                    orderListAdmin.innerHTML = ''; 

                    if (allOrdersData.length === 0) {
                        orderListAdmin.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Belum ada pesanan.</td></tr>';
                    } else {
                        const sortedOrdersForTable = [...allOrdersData].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                        sortedOrdersForTable.forEach(order => {
                            const row = document.createElement('tr');
                            const buktiUrl = order.bukti_bayar_url ? `http://localhost:3000/${order.bukti_bayar_url.replace(/\\/g, "/")}` : null;
                            let actionContent = '-'; 
                            if (order.status_pembayaran === 'Lunas') { actionContent = `<span class="text-green-600 font-semibold">Lunas</span>`; } 
                            else if (order.status_pembayaran === 'Menunggu Konfirmasi') { const paid = parseFloat(order.jumlah_bayar_klien)||0; const total = parseFloat(order.total_harga)||1; let perc = total > 0 ? Math.round((paid/total)*100) : 0; actionContent = `<div class="text-sm font-semibold text-orange-600 mb-1">${perc}% Dibayar</div> <button data-id="${order.order_id}" class="approve-btn text-green-600 hover:text-green-900 bg-green-100 px-3 py-1 rounded-md hover:bg-green-200 transition text-xs">Setujui Pelunasan</button>`; } 
                            row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${order.nama_klien}</div><div class="text-sm text-gray-500">${order.email_klien}</div></td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${order.nama_paket}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDateLong(order.tanggal_pernikahan)}</td> <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">${formatRupiah(order.total_harga)}</td> <td class="px-6 py-4 whitespace-nowrap">${getStatusBadge(order.status_pembayaran)}</td> <td class="px-6 py-4 whitespace-nowrap text-sm">${buktiUrl ? `<a href="${buktiUrl}" target="_blank" class="text-amber-600 hover:text-amber-900 hover:underline">Lihat</a><div class="text-xs text-gray-500 mt-1">${formatRupiah(order.jumlah_bayar_klien || 0)}</div>` : '-'}</td> <td class="px-6 py-4 whitespace-nowrap text-sm font-medium align-top">${actionContent}</td>`;
                            orderListAdmin.appendChild(row);
                        });
                    }

                    generateCalendar(currentDate.getFullYear(), currentDate.getMonth());

                    console.log("[loadAdminData] Fetching summary..."); 
                    const summaryResponse = await fetch(`${API_URL}/admin/financial-summary`, { headers: { 'x-auth-token': token } });
                     if (summaryResponse.ok) {
                        const summary = await summaryResponse.json();
                        console.log("[loadAdminData] Summary:", summary); 
                        totalRevenueEl.textContent = formatRupiah(summary.totalRevenue);
                        totalPaidOrdersEl.textContent = summary.totalPaidOrders;
                     } else { console.error("[loadAdminData] Gagal load summary."); totalRevenueEl.textContent = 'Error'; totalPaidOrdersEl.textContent = 'Error'; }

                    loadingMessage.classList.add('hidden');
                    adminContent.classList.remove('hidden');
                    console.log("[loadAdminData] Complete."); 

                } catch (error) {
                    console.error('[loadAdminData] Error:', error); 
                    loadingMessage.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg"><h3 class="font-bold text-lg">Error: ${error.message}</h3><p>Gagal memuat data.</p></div>`;
                }
            };

            // Handler Navigasi Kalender
            prevMonthBtn.addEventListener('click', () => { console.log("Prev month"); currentDate.setMonth(currentDate.getMonth() - 1); generateCalendar(currentDate.getFullYear(), currentDate.getMonth()); eventDetailsContainer.innerHTML = '<p class="text-gray-500">Klik tanggal...</p>'; checklistContainer.classList.add('hidden'); });
            nextMonthBtn.addEventListener('click', () => { console.log("Next month"); currentDate.setMonth(currentDate.getMonth() + 1); generateCalendar(currentDate.getFullYear(), currentDate.getMonth()); eventDetailsContainer.innerHTML = '<p class="text-gray-500">Klik tanggal...</p>'; checklistContainer.classList.add('hidden'); });

            // Handler Menyetujui Pembayaran
            orderListAdmin.addEventListener('click', async (e) => {
                if (e.target.classList.contains('approve-btn')) {
                    const button = e.target; const orderId = button.dataset.id;
                    console.log(`[Approve Btn] Clicked: ${orderId}`); 
                    const orderData = allOrdersData.find(o => o.order_id === orderId);
                    let confirmMsg = `Yakin setujui & LUNAS?`;
                    if(orderData){ const paid=parseFloat(orderData.jumlah_bayar_klien)||0; const total=parseFloat(orderData.total_harga)||1; if(paid<total) confirmMsg=`PERHATIAN: Baru bayar ${formatRupiah(paid)} dari ${formatRupiah(total)}. Yakin LUNAS?`; }
                    if (!confirm(confirmMsg)) return;
                    button.disabled = true; button.textContent = 'Memproses...'; const percentageInfo = button.previousElementSibling; 
                    try {
                        console.log(`[Approve Btn] Sending req: ${orderId}`); 
                        const response = await fetch(`${API_URL}/admin/orders/approve/${orderId}`, { method: 'PUT', headers: { 'x-auth-token': token } });
                        const data = await response.json(); if (!response.ok) { console.error("[Approve Btn] Failed:", data); throw new Error(data.message || 'Gagal.'); }
                        console.log("[Approve Btn] Success:", data); 
                        alert(data.message || 'Berhasil!'); 
                        await loadAdminData(); 
                    } catch (error) { 
                        console.error("[Approve Btn] Error:", error); 
                        alert(`Error: ${error.message}`); button.disabled = false; button.textContent = 'Setujui Pelunasan'; 
                        // Pastikan elemen sebelumnya adalah DIV sebelum menambahkannya kembali
                        if(percentageInfo && percentageInfo.tagName === 'DIV') { 
                           button.parentElement.insertBefore(percentageInfo, button); 
                        }
                    }
                }
            });

            // Handler Logout
            document.getElementById('logout-btn-admin').addEventListener('click', () => { if (confirm('Yakin logout?')) { console.log("Logging out..."); localStorage.removeItem('token'); localStorage.removeItem('user'); window.location.href = 'index.html'; } });

            // Panggil fungsi utama
            loadAdminData();
        });
    </script>
</body>
</html>

